---
title: "Crime in Vancouver"
author: "David Rucinski"
date: "June 6, 2019"
output:
  html_document:
    theme: cerulean
    highlight: espresso
    toc: true
    toc_float: false
    toc_depth: 4
    df_print: kable
    code_folding: hide
---

```{r include=FALSE}
knitr::opts_chunk$set(comment = NA)
```

## **Objective** [Change]
+questions
+summary from above


+Use and practice packages dplyr,ggplot2, and data.table. Create a report with HTML instead of pdf. Launch a website for the project, and eventually to host all repositories from github.



 Questions:
 Does more crime happen at later hours of the night (early morning 00:00-05:00) ?
 Has crime increased over the years ? 
   -> what about regional has it increased in certain neighbourhoods ?
 What type of crime appears most ?

 Are neighbourhoods targeted for certian crimes ? 



## **Summary** [Change]

Taking a look at the crime in Vancouver. I'm trying to translate the numbers into something more visual for people to see. How has crime changed over the years, are there neighbourhoods more prone to crimes, what time do most crimes happen? These are a few questions I would like to answer throught the data.

-summary
+summarize results
+reorder for Objective first

## **Preparations**

*Packages used:*
```{r packages, message = FALSE, warning=FALSE}
library(data.table)
library(ggplot2)
library(dplyr)
library(lubridate)
```

## **Analysis**

### Data

Source:
The data comes from the [Vancouver Open Data Catalogue (all years)](https://data.vancouver.ca/datacatalogue/crime-data.htm). It was extracted on 2019-06-11 and contains 603,986 records from 2003-01-01 to 2019-06-7. By David Rucinski


```{r loading data}
crime_all_years <- fread("crime_csv_all_years.csv")

# Check start and end dates
# crime_all_years %>%
#   arrange(desc(YEAR),desc(MONTH),desc(DAY)) %>%
#   head()
# 
# crime_all_years %>%
#   arrange(desc(YEAR),desc(MONTH),desc(DAY)) %>%
#   tail()
```

### Preprocessing

**To do:**
*-Combine date into single record*

*-Type, neighbourhood of crimes as factor*

*-Check hundred_block == "OFFSET TO PROTECT PRIVACY"*

*-Drop hundred_block*

*-Make plots*

```{r defining_a_theme, echo = FALSE}
theme_simple <- function(){
  theme_minimal() +
  theme(plot.background = element_rect(fill = "gray90"),
        plot.margin = unit(c(5, 10, 5, 10), units = "mm"),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        plot.caption = element_text(color = "gray20")
        ) 
}
``` 


#### Breakdown of crime
```{r counts}

# Dplyr way
 count_of_crimes <- crime_all_years %>%
   count(TYPE) %>%
   rename(total_of_crime = n)


# Data table way
crime_all_years[, .N, by = .(TYPE)]
```


Information removed to protect privacy on some crimes.
```{r offset info, warning=FALSE}

# Through the glimpse() I saw OFFSET TO PROTECT PRIVACY, just wondering what this is and why.
offset <- crime_all_years %>%
  filter(HUNDRED_BLOCK == "OFFSET TO PROTECT PRIVACY") %>%
  group_by(TYPE)

# Offset to protect privacy:
# What kind of a offensives would that need that?
offset <- as.data.table(offset)
offset[, .N, by = .(TYPE)]

```
Homicides make sense why you would want privacy, also for any unusual charges that would be easy to identify the persons involved through cross referencing news articles.




#### Clean date-time
```{r merge time to date}
crime_all_years$DATE <- with(crime_all_years, ymd(sprintf('%04d%02d%02d', YEAR, MONTH, DAY)))

# Gather up all the time data for crimes and we can look at a time-series analysis, see if there
# is any increase/decrease in crime of this data set. Also check to see time of day the crimes
# are usually committed.


# crime_all_years$TIME <- with(crime_all_years, hms(sprintf('%02d%02d', HOUR, MINUTE)))
#
# Find where na is at
# hour_no_na <- crime_all_years %>%
#   filter( !is.na(HOUR) )
#
# crime_all_years[!is.na(HOUR)]$TIME <- with(crime_all_years[!is.na(HOUR)], hms(sprintf('%02d%02d', HOUR, MINUTE)))
#
#
# Cannot create an hour-minute time with NA's, nor just the subset and let their time be NA.
# When checking time of crimes I will only use "HOUR" and exclude NA's

remove_list <- c("YEAR", "MONTH", "DAY", "MINUTE","HUNDRED_BLOCK")

# Removing some variables we won't need

crime_reduced <- crime_all_years %>%
  select( -remove_list ) %>%
  filter(!is.na(HOUR))
```
**Column names:**
```{r}
colnames(crime_reduced)
```
*Reordering column names*
```{r}
crime_tidy <- crime_reduced[, c(1,6,2,3,4,5)]
```
Let's check how our new data looks;
```{r}
glimpse(crime_tidy)
class(crime_tidy)
# TYPE and NEIGHBOURHOOD are characters, and crime_tidy is a dataframe, lets change those to factors so we can plot them and change the df to a data.table. DT will be faster, save some memory, and easy to manipulate.
```
**TYPE** and **NEIGHBOURHOOD** are characters, and crime_tidy is a dataframe, lets change those to factors so we can plot them and change the df to a data.table. DT will be faster, save some memory, and easy to manipulate.

```{r, warning=FALSE}
crime_tidy <- as.data.table(crime_tidy)

crime_tidy[, TYPE := as.factor(TYPE)]
crime_tidy[, NEIGHBOURHOOD := as.factor(NEIGHBOURHOOD)]

glimpse(crime_tidy)
class(crime_tidy)
```



### **Results**

#### Crime Distribution
```{r, fig.width = 12, fig.height = 8}

ggplot(count_of_crimes, aes(x = reorder(TYPE,total_of_crime), y = sqrt(total_of_crime) )) + 
  geom_col(fill = "steelblue") +
  coord_flip() + 
  scale_y_continuous(breaks=seq(0,550,50)) +
  labs( y = "Square Root of Total Crime", x = "Type of Crime Committed", title = "Crime Distribution", caption = "Vancouver 2003-2019", subtitle = "By Type of Crime") +
  geom_text(aes(label = round(sqrt(total_of_crime)), y = sqrt(total_of_crime) + 15)) + #adds num to bar
  theme_simple()
```

Here the count of total crimes is skewed, **Vehicle Collision or Pedestrian Struck (with Fatality) & Homicide** have such *low counts* relatively that they barely show on the plot. So finding a good transformation to visualize this I thought of taking the square root. It definitely holds its shape, unlike the log-transform that makes everything look near equal with the exceptation of 2 previous crimes.


#### Types of Crime at Hour
```{r All_years time of day, fig.width = 12, fig.height = 8}

crime_tidy %>%
ggplot( aes(x = HOUR, fill = TYPE)) +
  geom_bar(position = "stack") +
  labs(title = "Crime Distribution", subtitle = "By hour of day", caption = "Vancouver 2003-2019") +
  scale_fill_brewer() +
  theme_simple()
```
Most crime happens at the same time of day, but we need to look at this separately to see if all crimes fall under this. Expecting that some crimes should happen more during the day when people would not be home, i.e. break and entering a residential home.


```{r Time of day split per year, fig.width = 12, fig.height = 8, warning=FALSE}
crime_all_years %>%
ggplot( aes(x = HOUR)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Time of crime by year", subtitle = "By hour of day", caption = "Vancouver 2003-2019") +
  facet_wrap(~YEAR) +
  theme_simple()

```
Pretty steady trend throughout the years, the hour of when a crime is committed seems constant. The chance of a crime happening is more likely later in the day, little surprise is the peak at 18:00 (6 pm). We should look into if crime has been steady over the years or if there's any significant increase/decrease.


```{r, fig.width = 12, fig.height = 8}

# >>> HTML how to center graph ??

crime_tidy %>%
ggplot( aes(x = HOUR)) +
  geom_bar(fill = "steelblue") +
  labs(title = "What Time are Certain Crimes Committed?", subtitle = "By Type of Crime"  , caption = "Vancouver 2003-2019") +
  facet_wrap(~TYPE) 
```
Theft from Vehicle & of Vehicle spike in the late evening and drops just after midnight. I want to look into the break and enter categories, from here it looks like what would be expected. Which is break and entering into a commercial building when work hours are usually finished, break and entering into residential when they are at usual working hours.







```{r removed, include = FALSE}
# To run on lower spec computers
#
# Just to move into the right spot
#
# rm(crime_all_years, crime_reduced, remove_list)
```







>>>HERE<<<


#### Crime by Neighbourhood
```{r count by neighbourhood}

crime_tidy[, .N, by = .(NEIGHBOURHOOD)] %>%
  arrange(desc(N))

```

```{r neighbourhood plot, fig.width = 12, fig.height = 8}

# SQL in R: dyplr
crime_tidy %>%
  filter(NEIGHBOURHOOD != "Central Business District", NEIGHBOURHOOD != "") %>%
  count(NEIGHBOURHOOD) %>%
  group_by(NEIGHBOURHOOD) %>%
  rename(crimes_committed = n) %>%
ggplot( aes(x = reorder(NEIGHBOURHOOD,crimes_committed), y = sqrt(crimes_committed) ) ) +
  geom_col(fill = "steelblue") +
  labs(title = "Crime Count by Neighbourhood", subtitle = "Excluded: Central Business District & Missing Values due to Privacy" , caption = "Vancouver 2003-2019", x = "Neighbourhood", y = "Square Root of Crimes Committed") +
  coord_flip() +
  geom_text(aes(label = round(sqrt(crimes_committed)), y = sqrt(crimes_committed) + 5)) +
  theme_simple()

```
[Comment]



```{r longitude and latitude of neighbourhood, fig.width = 12, fig.height = 8}

crime_tidy %>%
  ggplot( aes(x = X,y = Y, color = NEIGHBOURHOOD)) +
  guides(color = guide_legend(override.aes = list(size=8))) + # resize the legend
  geom_point(alpha = 0.4, data = crime_tidy[crime_tidy$NEIGHBOURHOOD != "",] ) + 
  coord_cartesian(xlim = c(484000,498000), ylim = c(5450000, 5462500) ) +
  labs(title = "Longitude and Latitude of Crimes Committed", subtitle = "By Neighbourhood", caption = "Vancouver 2003-2019", y ="Latitude", x = "Longitude ") +
  theme_simple() +
  theme(legend.text = element_text(colour="gray15", size = 10),
        legend.title = element_text(colour="black", size = 12),
        plot.title = element_text(lineheight=3, face="bold", 
               color="black", size=14),
        plot.caption = element_text(color = "gray15")
        )

```
[comment]





```{r, fig.width = 12, fig.height = 8}
# Taking a look at Break and Enter
crime_tidy[TYPE  %like% "Break"] %>%
  ggplot( aes(x = HOUR)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Count of Crimes at Hour", subtitle = "YMD: 2003-01-01 to 2019-06-7") +
  facet_wrap(~TYPE)

# Just as expected, these crimes committed are at usual times they would be empty.
  
# Interesting, looks normal. I wonder why is that?
crime_tidy[TYPE  %like% "Other Theft"] %>%
  ggplot( aes(x = HOUR)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Other Theft")
```




